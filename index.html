<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>來口夢夢_V3</title>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      background:#111;
      min-height:100vh;
      color:white;
      font-family:sans-serif;
      padding:20px;
    }
    .main-container {
      display: flex;
      justify-content: center;
      gap: 20px;
      max-width: 1300px;
      margin: 0 auto;
    }
    .left-column {
      flex: 1;
      max-width: 950px;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    .right-column {
      width: 280px;
      min-width: 260px;
      text-align: center;
    }
    #board-container {
      position: relative;
      width: 100%;
      aspect-ratio: 1000 / 600;
      background-image: url("board.jpg");
      background-size: contain;
      background-repeat: no-repeat;
      background-position: center;
      border: 1px solid #444;
      overflow: hidden;
    }
    .player {
      position: absolute;
      width: 6vw;
      height: 6vw;
      max-width: 50px;
      max-height: 50px;
      border-radius: 50%;
      background-size: cover;
      background-position: center;
      transition: left 0.4s ease-in-out, top 0.4s ease-in-out, opacity 0.2s ease;
      pointer-events: auto;
      transform: translate(-50%, -50%);
      opacity: 1;
      border: 2px solid #fff;
      box-shadow: 0 0 8px rgba(0,0,0,0.6);
    }
    .player.moving {
      box-shadow: 0 0 20px #ffd700, 0 0 30px #ffeb3b;
      transform: translate(-50%, -50%) scale(1.15);
      transition: all 0.4s ease-in-out;
    }
    .player:hover { opacity: 0.2; cursor: default; }

    input[type="number"], button {
      padding: 8px 12px;
      font-size: 1rem;
      margin: 6px 0;
      width: 100%;
      max-width: 220px;
      text-align: center;
    }
    button {
      background: #4CAF50;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }
    button:hover { background: #45a049; }
    button:disabled {
      background: #555;
      cursor: not-allowed;
      opacity: 0.6;
    }
    #resetBtn { background: #f44336; }
    #resetBtn:hover:not(:disabled) { background: #da190b; }
    #changeImgBtn { background: #2196F3; }
    #changeImgBtn:hover:not(:disabled) { background: #0b7dda; }
    #fileInput { display: none; }

    #gifts-section {
      margin-top: 20px;
      padding: 12px;
      background: rgba(255,255,255,0.08);
      border-radius: 10px;
      width: 100%;
    }
    .gift-row {
      display: flex;
      align-items: center;
      margin: 8px 0;
      padding: 8px 6px;
      background: rgba(0,0,0,0.3);
      border-radius: 8px;
      cursor: pointer;
      user-select: none;
      transition: all 0.15s;
    }
    .gift-row:hover {
      background: rgba(255,255,255,0.12);
      transform: translateY(-1px);
    }
    .gift-row:active {
      transform: scale(0.97);
    }
    .gift-row img {
      width: 50px;
      height: 50px;
      object-fit: contain;
      margin-right: 12px;
      border-radius: 8px;
    }
    .gift-info {
      flex: 1;
      text-align: left;
      font-size: 1rem;
    }

    #event-log-container {
      width: 100%;
      background: rgba(0,0,0,0.4);
      border-radius: 8px;
      padding: 16px;
      border: 1px solid #444;
    }
    #event-log-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
      flex-wrap: wrap;
      gap: 10px;
    }
    #event-log h4 {
      margin: 0;
      color: #ffeb3b;
      font-size: 1.1rem;
    }
    .log-btn {
      font-size: 0.9rem;
      padding: 6px 16px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      color: white;
      min-width: 70px;
      text-align: center;
    }
    #clearLogBtn { background: #666; }
    #clearLogBtn:hover { background: #888; }
    #copyLogBtn { background: #2196F3; }
    #copyLogBtn:hover { background: #1e88e5; }
    #log-content {
      max-height: 300px;
      overflow-y: auto;
      font-size: 0.95rem;
    }
    .log-entry {
      margin-bottom: 8px;
      padding-bottom: 8px;
      border-bottom: 1px dashed #555;
      word-break: break-all;
    }
    .log-entry:last-child {
      border-bottom: none;
    }

    @media (max-width: 900px) {
      .main-container {
        flex-direction: column;
      }
      .right-column {
        width: 100%;
        max-width: 500px;
      }
      #event-log-header {
        flex-direction: column;
        align-items: flex-start;
      }
      .log-btn {
        width: 100%;
      }
    }
  </style>
</head>
<body>

<div class="main-container">
  <div class="left-column">
    <div id="board-container"></div>
    <div id="event-log-container">
      <div id="event-log">
        <div id="event-log-header">
          <h4>事件紀錄</h4>
          <div style="display:flex; gap:10px;">
            <button id="clearLogBtn" class="log-btn">清空紀錄</button>
            <button id="copyLogBtn" class="log-btn">複製全部</button>
          </div>
        </div>
        <div id="log-content">尚未觸發任何事件</div>
      </div>
    </div>
  </div>

  <div class="right-column" id="ui">
    <div>手動走幾格：</div>
    <input id="steps" type="number" value="3" min="1" max="10">
    <button id="moveBtn" onclick="startMovePlayer(1)">開始移動 玩家1</button>
    <button id="changeImgBtn" onclick="document.getElementById('fileInput').click()">
      更換角色圖片
    </button>
    <input type="file" id="fileInput" accept="image/*">
    <button id="resetBtn" onclick="resetGame()">重新開始</button>

    <div id="gifts-section">
      <h3 style="margin-bottom:12px; font-size:1.1rem;">點擊禮物直接使用</h3>

      <div class="gift-row" data-steps="1">
        <img src="3ffb357cca0d74346148b96d80d01ec492a82b61.png" alt="幸运泡泡">
        <div class="gift-info">幸运泡泡　→ 走 1 步</div>
      </div>

      <div class="gift-row" data-steps="3">
        <img src="a2e8254f5c533a9b3f00201a8878c37fffd40651.png" alt="星光铃铛">
        <div class="gift-info">星光铃铛　→ 走 3 步</div>
      </div>

      <div class="gift-row" data-steps="2">
        <img src="792e1ae4e92cc33fa323970c55464ff6240959f0.png" alt="好运柚叶">
        <div class="gift-info">好运柚叶　→ 走 2 步</div>
      </div>

      <div class="gift-row" data-steps="5">
        <img src="ee4281781ecf14bef08e3114b1a7c4e8a548d7f4.png" alt="梦雾纸签">
        <div class="gift-info">梦雾纸签　→ 走 5 步</div>
      </div>

      <div class="gift-row" data-steps="8">
        <img src="c9740b1646be8b028b6d90253cda2b79fa9a23d2.png" alt="福灵小兽">
        <div class="gift-info">福灵小兽　→ 走 8 步</div>
      </div>

      <div class="gift-row" data-steps="10">
        <img src="61ad06ac8b28732443d8639cc2087f4dc6a2b1ca.png" alt="星愿花园">
        <div class="gift-info">星愿花园　→ 走 10 步</div>
      </div>
    </div>
  </div>
</div>

<script>
const path = [
  {"x": 350, "y": 60},
  {"x":411,"y":60},{"x":472,"y":60},{"x":533,"y":60},{"x":595,"y":60},
  {"x":656,"y":60},{"x":717,"y":60},{"x":778,"y":60},{"x":840,"y":60},
  {"x":901,"y":60},{"x":962,"y":60},{"x":964,"y":119},{"x":964,"y":178},
  {"x":902,"y":180},{"x":840,"y":180},{"x":778,"y":180},{"x":716,"y":180},
  {"x":654,"y":180},{"x":592,"y":180},{"x":530,"y":180},{"x":468,"y":180},
  {"x":406,"y":180},{"x":409,"y":240},{"x":409,"y":301},{"x":409,"y":361},
  {"x":409,"y":421},{"x":409,"y":482},{"x":409,"y":542},{"x":469,"y":544},
  {"x":531,"y":544},{"x":593,"y":544},{"x":654,"y":544},{"x":716,"y":544},
  {"x":778,"y":544},{"x":840,"y":544},{"x":901,"y":544},{"x":963,"y":544},
  {"x":964,"y":484},{"x":964,"y":425},{"x":965,"y":365},{"x":965,"y":305},
  {"x":904,"y":300},{"x":842,"y":300},{"x":779,"y":300},{"x":717,"y":300},
  {"x":655,"y":300},{"x":592,"y":300},{"x":530,"y":300},{"x":530,"y":364},
  {"x":531,"y":423},{"x":591,"y":423}
];

const REFERENCE_WIDTH = 1000;
let scale = 1;
let isMoving = false;

const players = {
  1: { el: null, pos: 0, imageUrl: "player.png" }
};

const events = [
  "", "深蹲5下", "真心话1个", "前进5格", "禁言主播上麦5分钟",
  "把id改成主播の小狗一天", "无事发生", "猪哼3次", "亲亲5下",
  "送一个蓝色的礼物", "后退3格", "无事发生", "换指定头像",
  "含水说123", "老公天下第一", "上麦喊姐姐", "前进两格",
  "送一个黄色的礼物", "无事发生", "叫醒卡1次",
  "发动态，问口水为什么对痔疮没用", "送一个喜欢你", "回到起点",
  "叫老公", "点亮1个星球", "打pp10下", "后退3格",
  "亲亲3下", "发个红包", "无事发生", "表白30秒",
  "闽南话5分钟", "后退4格", "帮主播打赢一场pk",
  "连睡卡1次", "pk去对面说你敢动我得女人不要命了", "冠名一天",
  "给梦梦点奶茶", "无事发生", "前进2格", "开个心动盲盒",
  "梦梦给你点奶茶", "后退6格", "边亲边骂三连击", "直达终点",
  "狗狗叫5声", "无事发生", "指定称呼*1天", "送一个情书",
  "展示手机相册最近三张照片", "終點"
];

let eventLog = [];

function addToLog(message) {
  eventLog.push(message);
  const logContent = document.getElementById('log-content');
  if (logContent) {
    logContent.innerHTML = eventLog.map((item, i) => 
      `<div class="log-entry">${i+1}. ${item}</div>`
    ).join('');
    
    if (eventLog.length === 0) {
      logContent.innerHTML = "尚未觸發任何事件";
    }
    
    logContent.scrollTop = logContent.scrollHeight;
    setTimeout(() => {
      logContent.scrollTop = logContent.scrollHeight;
    }, 50);
  }
}

function createPlayer(playerId) {
  const player = document.createElement('div');
  player.className = 'player';
  player.id = `player-${playerId}`;
  player.style.backgroundImage = `url(${players[playerId].imageUrl})`;
  document.getElementById('board-container').appendChild(player);
  players[playerId].el = player;
}

function getScaledPos(pos) {
  if (pos < 0) pos = 0;
  if (pos >= path.length) pos = path.length - 1;
  return {
    left: path[pos].x * scale,
    top: path[pos].y * scale
  };
}

function setPlayerPosition(playerId, cellIndex) {
  const player = players[playerId];
  if (!player?.el) return;
  player.pos = cellIndex;
  const {left, top} = getScaledPos(cellIndex);
  player.el.style.left = left + 'px';
  player.el.style.top  = top + 'px';
}

function updateScale() {
  const container = document.getElementById('board-container');
  const rect = container.getBoundingClientRect();
  scale = rect.width / REFERENCE_WIDTH;
  Object.keys(players).forEach(id => setPlayerPosition(Number(id), players[id].pos));
}

async function moveStepByStep(playerId, steps) {
  if (isMoving) return;
  isMoving = true;
  document.getElementById('moveBtn').disabled = true;

  let current = players[playerId].pos;
  let target = Math.min(current + steps, path.length - 1);

  players[playerId].el.classList.add('moving');

  while (current < target) {
    current++;
    setPlayerPosition(playerId, current);
    await new Promise(r => setTimeout(r, 450));
  }

  players[playerId].el.classList.remove('moving');
  isMoving = false;
  document.getElementById('moveBtn').disabled = false;

  checkEventAfterMove(playerId, 0);
}

function startMovePlayer(playerId) {
  if (isMoving) return;
  const steps = Math.max(1, Math.min(10, parseInt(document.getElementById('steps').value) || 1));
  moveStepByStep(playerId, steps);
}

async function useGift(steps) {
  if (steps <= 0 || isMoving) {
    if (isMoving) alert("正在移動中，請稍等～");
    return;
  }
  await moveStepByStep(1, steps);
}

function checkEventAfterMove(playerId, depth = 0) {
  if (depth > 10) {
    addToLog("事件連鎖過深，已停止");
    return;
  }

  const pos = players[playerId].pos;
  if (pos < 1 || pos >= events.length) return;

  const eventText = events[pos];
  if (!eventText || eventText === "") return;

  let finalText = eventText;
  let newPos = pos;
  let moved = false;

  if (eventText.includes("前进")) {
    const num = parseInt(eventText.match(/\d+/)?.[0] || 0);
    if (num > 0) {
      newPos = Math.min(pos + num, path.length - 1);
      finalText += ` （自動前進 ${num} 格）`;
      moved = true;
    }
  } else if (eventText.includes("后退")) {
    const num = parseInt(eventText.match(/\d+/)?.[0] || 0);
    if (num > 0) {
      newPos = Math.max(0, pos - num);
      finalText += ` （自動後退 ${num} 格）`;
      moved = true;
    }
  } else if (eventText === "回到起点") {
    newPos = 0;
    finalText += " （已回到起點）";
    moved = true;
  } else if (eventText === "直达终点") {
    newPos = path.length - 1;
    finalText += " （已直達終點！）";
    moved = true;
  }

  const logMsg = `格子 ${pos}：${finalText}`;
  addToLog(logMsg);

  alert(`踩到事件格！\n${finalText}`);

  if (moved) {
    setPlayerPosition(playerId, newPos);
    setTimeout(() => {
      checkEventAfterMove(playerId, depth + 1);
    }, 800);
  }
}

function resetGame() {
  setPlayerPosition(1, 0);
  document.getElementById('steps').value = 3;
  document.getElementById('moveBtn').disabled = false;
  isMoving = false;
  players[1].el?.classList.remove('moving');
}

// 清空紀錄
document.getElementById('clearLogBtn')?.addEventListener('click', () => {
  if (confirm("確定要清空所有事件紀錄嗎？")) {
    eventLog = [];
    document.getElementById('log-content').innerHTML = "尚未觸發任何事件";
  }
});

// 複製全部
document.getElementById('copyLogBtn')?.addEventListener('click', () => {
  if (eventLog.length === 0) {
    alert("目前沒有任何事件可複製");
    return;
  }

  const logText = eventLog.map((item, i) => `${i+1}. ${item}`).join('\n');
  navigator.clipboard.writeText(logText)
    .then(() => {
      alert("已複製全部事件紀錄到剪貼簿！");
    })
    .catch(err => {
      console.error('複製失敗:', err);
      alert("複製失敗，請手動選取複製");
    });
});

// 綁定禮物點擊
document.querySelectorAll('.gift-row').forEach(row => {
  row.addEventListener('click', () => {
    const steps = parseInt(row.dataset.steps) || 0;
    useGift(steps);
  });
});

document.getElementById('fileInput').addEventListener('change', function(e) {
  const file = e.target.files[0];
  if (file) {
    const reader = new FileReader();
    reader.onload = function(ev) {
      players[1].imageUrl = ev.target.result;
      if (players[1].el) players[1].el.style.backgroundImage = `url(${ev.target.result})`;
    };
    reader.readAsDataURL(file);
  }
});

window.addEventListener('load', () => {
  createPlayer(1);
  setPlayerPosition(1, 0);
  updateScale();
});

window.addEventListener('resize', updateScale);
</script>

</body>
</html>