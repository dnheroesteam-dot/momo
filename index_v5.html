<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ä¾†å£å¤¢å¤¢_V5 å¤šç©å®¶ç‰ˆ</title>
<style>
* {
  margin:0;
  padding:0;
  box-sizing:border-box;
}
body {
  background:#111;
  min-height:100vh;
  color:white;
  font-family:sans-serif;
  padding:20px;
}
.main-container {
  display: flex;
  justify-content: center;
  gap: 20px;
  max-width: 1600px;
  margin: 0 auto;
}
.left-column {
  flex: 5;
  display: flex;
  flex-direction: column;
  gap: 20px;
}
.right-column {
  flex: 3;
  display: flex;
  flex-direction: row;
  gap: 20px;
  align-items: flex-start;
}
#board-container {
  position: relative;
  width: 100%;
  aspect-ratio: 1000 / 600;
  background-image: url("board.jpg");
  background-size: contain;
  background-repeat: no-repeat;
  background-position: center;
  border: 1px solid #444;
  overflow: hidden;
}
.player {
  position: absolute;
  width: 6vw;
  height: 6vw;
  max-width: 50px;
  max-height: 50px;
  border-radius: 50%;
  background-size: cover;
  background-position: center;
  transition: left 0.4s ease-in-out, top 0.4s ease-in-out, opacity 0.2s ease;
  pointer-events: auto;
  transform: translate(-50%, -50%);
  opacity: 1;
  border: 2px solid #fff;
  box-shadow: 0 0 8px rgba(0,0,0,0.6);
}
.player.moving {
  box-shadow: 0 0 20px #ffd700, 0 0 30px #ffeb3b;
  transform: translate(-50%, -50%) scale(1.15);
  transition: all 0.4s ease-in-out;
}
.player:hover {
  opacity: 0.2;
  cursor: default;
}
.player.selected {
  border-color: #ffd700;
  box-shadow: 0 0 15px #ffd700, 0 0 25px #ffeb3b;
  transform: translate(-50%, -50%) scale(1.1);
}
input[type="number"], button, input[type="text"] {
  padding: 8px 12px;
  font-size: 1rem;
  margin: 6px 0;
  width: 100%;
  max-width: 220px;
  text-align: center;
  box-sizing: border-box;
}
input[type="text"] {
  background: rgba(255,255,255,0.1);
  border: 1px solid #444;
  color: white;
  border-radius: 6px;
}
input[type="text"]:focus {
  outline: none;
  border-color: #4CAF50;
  box-shadow: 0 0 5px rgba(76,175,80,0.5);
}
button {
  background: #4CAF50;
  color: white;
  border: none;
  border-radius: 6px;
  cursor: pointer;
}
button:hover:not(:disabled) {
  background: #45a049;
}
button:disabled {
  background: #555;
  cursor: not-allowed;
  opacity: 0.6;
}
#addPlayerBtn {
  background: #9C27B0;
  font-size: 1.1rem;
}
#addPlayerBtn:hover:not(:disabled) {
  background: #7B1FA2;
}
#resetBtn {
  background: #f44336;
}
#resetBtn:hover:not(:disabled) {
  background: #da190b;
}
input[type="file"] { display: none; }

.ui-section {
  flex: 1;
  background: rgba(255,255,255,0.08);
  border-radius: 10px;
  padding: 15px;
  min-width: 0;
}
.ui-section h3 {
  margin-bottom: 12px;
  font-size: 1.1rem;
  text-align: center;
}

.player-row {
  display: flex;
  flex-direction: column;
  gap: 8px;
  margin-bottom: 15px;
  padding: 12px;
  background: rgba(0,0,0,0.3);
  border-radius: 8px;
  cursor: pointer;
  user-select: none;
  transition: all 0.2s;
  border: 2px solid transparent;
}
.player-row:hover {
  background: rgba(255,255,255,0.12);
  transform: translateY(-2px);
}
.player-row.selected {
  background: rgba(255,215,0,0.2);
  border-color: #ffd700;
  box-shadow: 0 0 10px rgba(255,215,0,0.5);
}
.player-row-header {
  display: flex;
  align-items: center;
  gap: 10px;
  font-weight: bold;
  font-size: 1.1rem;
}
.color-dot {
  width: 20px;
  height: 20px;
  border-radius: 50%;
  border: 2px solid white;
}
.player-name-input {
  flex: 1;
  background: none;
  border: none;
  color: inherit;
  font: inherit;
  font-weight: bold;
  cursor: pointer;
}
.player-name-input:focus {
  outline: none;
  background: rgba(255,255,255,0.2);
  border-radius: 4px;
  padding: 2px 4px;
}
.player-pos {
  font-size: 0.9rem;
  color: #ffeb3b;
}
.player-controls {
  display: flex;
  gap: 6px;
  flex-wrap: wrap;
}
.player-controls button {
  flex: 1;
  min-width: 60px;
  padding: 6px 8px;
  font-size: 0.85rem;
}
.player-controls .color-btn {
  background: #3498db;
}
.player-controls .color-btn:hover {
  background: #2980b9;
}
.player-controls .delete-btn {
  background: #e74c3c;
}
.player-controls .delete-btn:hover {
  background: #c0392b;
}

.move-controls {
  display: flex;
  flex-direction: column;
  gap: 10px;
  align-items: center;
}
.move-controls > div:first-child {
  font-weight: bold;
  color: #ffeb3b;
}
.move-input-row {
  display: flex;
  gap: 8px;
  width: 100%;
  justify-content: center;
}
.move-input-row input {
  width: 60px;
  flex-shrink: 0;
}
.move-input-row button {
  flex: 1;
  white-space: nowrap;
}
.gifts-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 10px;
  margin-top: 5px;
}
.gift-item {
  background: rgba(0,0,0,0.3);
  border-radius: 8px;
  padding: 10px;
  cursor: pointer;
  user-select: none;
  transition: all 0.15s;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 5px;
  height: 100%;
}
.gift-item:hover {
  background: rgba(255,255,255,0.12);
  transform: translateY(-2px);
}
.gift-item:active {
  transform: scale(0.97);
}
.gift-item img {
  width: 40px;
  height: 40px;
  object-fit: contain;
  border-radius: 6px;
}
.gift-info {
  font-size: 0.85rem;
  text-align: center;
  line-height: 1.2;
}
.reset-section {
  margin-top: 10px;
  display: flex;
  justify-content: center;
}
#event-log-container {
  width: 100%;
  background: rgba(0,0,0,0.4);
  border-radius: 8px;
  padding: 16px;
  border: 1px solid #444;
}
#event-log-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 12px;
  flex-wrap: wrap;
  gap: 10px;
}
#event-log h4 {
  margin: 0;
  color: #ffeb3b;
  font-size: 1.1rem;
}
.log-btn {
  font-size: 0.9rem;
  padding: 6px 16px;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  color: white;
  min-width: 70px;
  text-align: center;
}
#clearLogBtn { background: #666; }
#clearLogBtn:hover { background: #888; }
#copyLogBtn { background: #2196F3; }
#copyLogBtn:hover { background: #1e88e5; }
#log-content {
  max-height: 300px;
  overflow-y: auto;
  font-size: 0.95rem;
}
.log-entry {
  margin-bottom: 8px;
  padding-bottom: 8px;
  border-bottom: 1px dashed #555;
  word-break: break-all;
}
.log-entry:last-child { border-bottom: none; }
.log-entry .player-name { color: #4CAF50; font-weight: bold; }

@media (max-width: 1200px) {
  .main-container { flex-direction: column; }
  .right-column { flex-direction: column; width: 100%; }
}
@media (max-width: 500px) {
  .gifts-grid { grid-template-columns: repeat(2, 1fr); }
}
</style>
</head>
<body>

<div class="main-container">
  <div class="left-column">
    <div id="board-container"></div>
    <div id="event-log-container">
      <div id="event-log">
        <div id="event-log-header">
          <h4>äº‹ä»¶ç´€éŒ„</h4>
          <div style="display:flex; gap:10px;">
            <button id="clearLogBtn" class="log-btn">æ¸…ç©ºç´€éŒ„</button>
            <button id="copyLogBtn" class="log-btn">è¤‡è£½å…¨éƒ¨</button>
          </div>
        </div>
        <div id="log-content">å°šæœªè§¸ç™¼ä»»ä½•äº‹ä»¶</div>
      </div>
    </div>
  </div>
  
  <div class="right-column" id="ui">
    <div id="players-section" class="ui-section">
      <h3>ç©å®¶ç®¡ç†</h3>
      <button id="addPlayerBtn">â• æ–°å¢ç©å®¶</button>
      <div id="players-list"></div>
    </div>
    
    <div id="move-gift-section" class="ui-section">
      <div class="move-controls">
        <div>æ‰‹å‹•èµ°å¹¾æ ¼ï¼š</div>
        <div class="move-input-row">
          <input id="steps" type="number" value="3" min="1" max="10">
          <button id="moveBtn" disabled>é–‹å§‹ç§»å‹•ï¼ˆé¸ä¸­ç©å®¶ï¼‰</button>
        </div>
      </div>
      
      <div>
        <h4 style="margin-bottom:8px; font-size:1rem;">é»æ“Šç¦®ç‰©ç›´æ¥ä½¿ç”¨ï¼ˆé¸ä¸­ç©å®¶ï¼‰</h4>
        <div class="gifts-grid">
          <div class="gift-item" data-steps="1">
            <img src="3ffb357cca0d74346148b96d80d01ec492a82b61.png" alt="å¹¸è¿æ³¡æ³¡">
            <div class="gift-info">å¹¸è¿æ³¡æ³¡<br>èµ° 1 æ­¥</div>
          </div>
          <div class="gift-item" data-steps="3">
            <img src="a2e8254f5c533a9b3f00201a8878c37fffd40651.png" alt="æ˜Ÿå…‰é“ƒé“›">
            <div class="gift-info">æ˜Ÿå…‰é“ƒé“›<br>èµ° 3 æ­¥</div>
          </div>
          <div class="gift-item" data-steps="2">
            <img src="792e1ae4e92cc33fa323970c55464ff6240959f0.png" alt="å¥½è¿æŸšå¶">
            <div class="gift-info">å¥½è¿æŸšå¶<br>èµ° 2 æ­¥</div>
          </div>
          <div class="gift-item" data-steps="5">
            <img src="ee4281781ecf14bef08e3114b1a7c4e8a548d7f4.png" alt="æ¢¦é›¾çº¸ç­¾">
            <div class="gift-info">æ¢¦é›¾çº¸ç­¾<br>èµ° 5 æ­¥</div>
          </div>
          <div class="gift-item" data-steps="8">
            <img src="c9740b1646be8b028b6d90253cda2b79fa9a23d2.png" alt="ç¦çµå°å…½">
            <div class="gift-info">ç¦çµå°å…½<br>èµ° 8 æ­¥</div>
          </div>
          <div class="gift-item" data-steps="10">
            <img src="61ad06ac8b28732443d8639cc2087f4dc6a2b1ca.png" alt="æ˜Ÿæ„¿èŠ±å›­">
            <div class="gift-info">æ˜Ÿæ„¿èŠ±å›­<br>èµ° 10 æ­¥</div>
          </div>
        </div>
      </div>
      
      <div class="reset-section">
        <button id="resetBtn" style="width: 100%; max-width: 250px;">ğŸ”„ é‡æ–°é–‹å§‹ï¼ˆæ‰€æœ‰ç©å®¶ï¼‰</button>
      </div>
    </div>
  </div>
</div>

<script>
const path = [
  {"x": 350, "y": 60}, {"x":411,"y":60},{"x":472,"y":60},{"x":533,"y":60},{"x":595,"y":60},
  {"x":656,"y":60},{"x":717,"y":60},{"x":778,"y":60},{"x":840,"y":60},
  {"x":901,"y":60},{"x":962,"y":60},{"x":964,"y":119},{"x":964,"y":178},
  {"x":902,"y":180},{"x":840,"y":180},{"x":778,"y":180},{"x":716,"y":180},
  {"x":654,"y":180},{"x":592,"y":180},{"x":530,"y":180},{"x":468,"y":180},
  {"x":406,"y":180},{"x":409,"y":240},{"x":409,"y":301},{"x":409,"y":361},
  {"x":409,"y":421},{"x":409,"y":482},{"x":409,"y":542},{"x":469,"y":544},
  {"x":531,"y":544},{"x":593,"y":544},{"x":654,"y":544},{"x":716,"y":544},
  {"x":778,"y":544},{"x":840,"y":544},{"x":901,"y":544},{"x":963,"y":544},
  {"x":964,"y":484},{"x":964,"y":425},{"x":965,"y":365},{"x":965,"y":305},
  {"x":904,"y":300},{"x":842,"y":300},{"x":779,"y":300},{"x":717,"y":300},
  {"x":655,"y":300},{"x":592,"y":300},{"x":530,"y":300},{"x":530,"y":364},
  {"x":531,"y":423}
];

const TOTAL_POS = path.length - 1;
const REFERENCE_WIDTH = 1000;

let scale = 1;
let isMoving = false;
let selectedPlayerId = null;
let nextPlayerId = 1;

const defaultPlayerColors = ['#ff6b6b', '#4ecdc4', '#45b7d1', '#96ceb4', '#feca57', '#ff9ff3', '#54a0ff'];
const customPlayerColors = {}; // è¨˜éŒ„æ¯å€‹ç©å®¶çš„è‡ªè¨‚é‚Šæ¡†é¡è‰²
const players = {};

const events = [
  "", "æ·±è¹²5ä¸‹", "çœŸå¿ƒè¯1ä¸ª", "å‰è¿›5æ ¼", "ç¦è¨€ä¸»æ’­ä¸Šéº¦5åˆ†é’Ÿ", "æŠŠidæ”¹æˆä¸»æ’­ã®å°ç‹—ä¸€å¤©", "æ— äº‹å‘ç”Ÿ", "çŒªå“¼3æ¬¡", "äº²äº²5ä¸‹", "é€ä¸€ä¸ªè“è‰²çš„ç¤¼ç‰©", "åé€€3æ ¼", "æ— äº‹å‘ç”Ÿ", "æ¢æŒ‡å®šå¤´åƒ", "å«æ°´è¯´123", "è€å…¬å¤©ä¸‹ç¬¬ä¸€", "ä¸Šéº¦å–Šå§å§", "å‰è¿›2æ ¼", "é€ä¸€ä¸ªé»„è‰²çš„ç¤¼ç‰©", "æ— äº‹å‘ç”Ÿ", "å«é†’å¡1æ¬¡", "å‘åŠ¨æ€ï¼Œé—®å£æ°´ä¸ºä»€ä¹ˆå¯¹ç—”ç–®æ²¡ç”¨", "é€ä¸€ä¸ªå–œæ¬¢ä½ ", "å›åˆ°èµ·ç‚¹", "å«è€å…¬", "ç‚¹äº®1ä¸ªæ˜Ÿçƒ", "æ‰“pp10ä¸‹", "åé€€3æ ¼", "äº²äº²3ä¸‹", "å‘ä¸ªçº¢åŒ…", "æ— äº‹å‘ç”Ÿ", "è¡¨ç™½30ç§’", "é—½å—è¯5åˆ†é’Ÿ", "åé€€4æ ¼", "å¸®ä¸»æ’­æ‰“èµ¢ä¸€åœºpk", "è¿ç¡å¡1æ¬¡", "pkå»å¯¹é¢è¯´ä½ æ•¢åŠ¨æˆ‘å¾—å¥³äººä¸è¦å‘½äº†", "å† åä¸€å¤©", "ç»™æ¢¦æ¢¦ç‚¹å¥¶èŒ¶", "æ— äº‹å‘ç”Ÿ", "å‰è¿›2æ ¼", "å¼€ä¸ªå¿ƒåŠ¨ç›²ç›’", "æ¢¦æ¢¦ç»™ä½ ç‚¹å¥¶èŒ¶", "åé€€6æ ¼", "è¾¹äº²è¾¹éª‚ä¸‰è¿å‡»", "ç›´è¾¾ç»ˆç‚¹", "ç‹—ç‹—å«5å£°", "æ— äº‹å‘ç”Ÿ", "æŒ‡å®šç§°å‘¼*1å¤©", "é€ä¸€ä¸ªæƒ…ä¹¦", "å±•ç¤ºæ‰‹æœºç›¸å†Œæœ€è¿‘ä¸‰å¼ ç…§ç‰‡", "çµ‚é»"
];

let eventLog = [];

function addToLog(message) {
  eventLog.push(message);
  const logContent = document.getElementById('log-content');
  logContent.innerHTML = eventLog.map((item, i) => 
    `<div class="log-entry">${i+1}. ${item}</div>`
  ).join('');
  if (eventLog.length === 0) {
    logContent.innerHTML = "å°šæœªè§¸ç™¼ä»»ä½•äº‹ä»¶";
  }
  logContent.scrollTop = logContent.scrollHeight;
}

function createPlayer(id) {
  const player = document.createElement('div');
  player.className = 'player';
  player.id = `player-${id}`;
  
  // ä½¿ç”¨è‡ªè¨‚é¡è‰²æˆ–é è¨­é¡è‰²
  const borderColor = customPlayerColors[id] || defaultPlayerColors[id % defaultPlayerColors.length];
  player.style.borderColor = borderColor;

  document.getElementById('board-container').appendChild(player);
  players[id].el = player;
  setPlayerPosition(id, players[id].pos);
}

function getScaledPos(pos) {
  if (pos < 0) pos = 0;
  if (pos > TOTAL_POS) pos = TOTAL_POS;
  return {
    left: path[pos].x * scale,
    top: path[pos].y * scale
  };
}

function setPlayerPosition(id, cellIndex) {
  const player = players[id];
  if (!player?.el) return;
  player.pos = cellIndex;
  const {left, top} = getScaledPos(cellIndex);
  player.el.style.left = left + 'px';
  player.el.style.top = top + 'px';
  updatePlayerListUI();
}

function updatePlayerSelection(id) {
  selectedPlayerId = id;
  Object.keys(players).forEach(pid => {
    players[pid].el?.classList.toggle('selected', pid == id);
  });
  updatePlayerListUI();
  document.getElementById('moveBtn').disabled = false;
}

function updatePlayerListUI() {
  const container = document.getElementById('players-list');
  container.innerHTML = '';
  Object.entries(players).forEach(([id, data]) => {
    const row = document.createElement('div');
    row.className = `player-row ${selectedPlayerId == id ? 'selected' : ''}`;
    row.dataset.playerId = id;

    const dotColor = customPlayerColors[id] || defaultPlayerColors[id % defaultPlayerColors.length];

    row.innerHTML = `
      <div class="player-row-header">
        <div class="color-dot" style="background-color: ${dotColor}"></div>
        <input type="text" class="player-name-input" value="${data.name}" placeholder="ç©å®¶åç¨±">
        <div class="player-pos">ä½ç½®: ${data.pos}/${TOTAL_POS}</div>
      </div>
      <div class="player-controls">
        <button onclick="changePlayerImage(${id})">æ›åœ–</button>
        <button class="color-btn" onclick="changePlayerColor(${id})">æ”¹é¡è‰²</button>
        <button class="delete-btn" onclick="deletePlayer(${id})">åˆªé™¤</button>
        <input type="file" class="file-input-${id}" accept="image/*" style="display:none;">
      </div>
    `;
    row.addEventListener('click', (e) => {
      if (e.target.tagName !== 'INPUT' && e.target.tagName !== 'BUTTON') {
        updatePlayerSelection(id);
      }
    });
    container.appendChild(row);
  });
}

function changePlayerImage(id) {
  document.querySelector(`.file-input-${id}`).click();
}

function changePlayerColor(id) {
  const currentColor = customPlayerColors[id] || defaultPlayerColors[id % defaultPlayerColors.length];

  const picker = document.createElement('input');
  picker.type = 'color';
  picker.value = currentColor;
  picker.style.position = 'absolute';
  picker.style.opacity = '0';
  picker.style.pointerEvents = 'none';
  document.body.appendChild(picker);

  picker.addEventListener('change', () => {
    const newColor = picker.value;
    customPlayerColors[id] = newColor;

    // æ›´æ–°æ£‹å­é‚Šæ¡†
    if (players[id]?.el) {
      players[id].el.style.borderColor = newColor;
    }

    // æ›´æ–°åˆ—è¡¨
    updatePlayerListUI();

    document.body.removeChild(picker);
  }, { once: true });

  picker.click();
}

function deletePlayer(id) {
  if (Object.keys(players).length <= 1) {
    alert("è‡³å°‘è¦ä¿ç•™ä¸€å€‹ç©å®¶å–”ï½");
    return;
  }

  if (!confirm(`ç¢ºå®šè¦åˆªé™¤ç©å®¶ã€Œ${players[id].name}ã€å—ï¼Ÿ`)) return;

  if (selectedPlayerId === Number(id)) {
    selectedPlayerId = null;
    document.getElementById('moveBtn').disabled = true;
  }

  if (players[id]?.el) {
    players[id].el.remove();
  }

  delete players[id];
  delete customPlayerColors[id];

  updatePlayerListUI();
}

function updateScale() {
  const container = document.getElementById('board-container');
  const rect = container.getBoundingClientRect();
  scale = rect.width / REFERENCE_WIDTH;
  Object.keys(players).forEach(id => setPlayerPosition(id, players[id].pos));
}

async function moveStepByStep(playerId, steps) {
  if (isMoving || !players[playerId]) return;
  isMoving = true;
  document.getElementById('moveBtn').disabled = true;
  let current = players[playerId].pos;
  let target = Math.min(current + steps, TOTAL_POS);
  const playerEl = players[playerId].el;
  playerEl.classList.add('moving');
  playerEl.classList.add('selected');
  
  while (current < target) {
    current++;
    setPlayerPosition(playerId, current);
    await new Promise(r => setTimeout(r, 450));
  }
  
  playerEl.classList.remove('moving');
  isMoving = false;
  document.getElementById('moveBtn').disabled = false;
  checkEventAfterMove(playerId, 0);
}

function startMovePlayer() {
  if (!selectedPlayerId) {
    alert('è«‹å…ˆé¸æ“‡ä¸€å€‹ç©å®¶ï¼');
    return;
  }
  const steps = Math.max(1, Math.min(10, parseInt(document.getElementById('steps').value) || 1));
  moveStepByStep(selectedPlayerId, steps);
}

async function useGift(steps) {
  if (!selectedPlayerId) {
    alert('è«‹å…ˆé¸æ“‡ä¸€å€‹ç©å®¶ï¼');
    return;
  }
  if (steps <= 0 || isMoving) {
    if (isMoving) alert("æ­£åœ¨ç§»å‹•ä¸­ï¼Œè«‹ç¨ç­‰ï½");
    return;
  }
  await moveStepByStep(selectedPlayerId, steps);
}

function checkEventAfterMove(playerId, depth = 0) {
  if (depth > 10) {
    addToLog(`${players[playerId].name}ï¼šäº‹ä»¶é€£é–éæ·±ï¼Œå·²åœæ­¢`);
    return;
  }
  
  const pos = players[playerId].pos;
  if (pos < 1 || pos >= events.length) return;
  const eventText = events[pos];
  if (!eventText || eventText === "") return;
  
  let finalText = eventText;
  let newPos = pos;
  let moved = false;
  let isWin = false;
  
  if (eventText.includes("å‰è¿›")) {
    const num = parseInt(eventText.match(/\d+/)?.[0] || 0);
    if (num > 0) {
      newPos = Math.min(pos + num, TOTAL_POS);
      finalText += `ï¼ˆè‡ªå‹•å‰é€² ${num} æ ¼ï¼‰`;
      moved = true;
    }
  } else if (eventText.includes("åé€€")) {
    const num = parseInt(eventText.match(/\d+/)?.[0] || 0);
    if (num > 0) {
      newPos = Math.max(0, pos - num);
      finalText += `ï¼ˆè‡ªå‹•å¾Œé€€ ${num} æ ¼ï¼‰`;
      moved = true;
    }
  } else if (eventText === "å›åˆ°èµ·ç‚¹") {
    newPos = 0;
    finalText += " ï¼ˆå·²å›åˆ°èµ·é»ï¼‰";
    moved = true;
  } else if (eventText === "ç›´è¾¾ç»ˆç‚¹") {
    newPos = TOTAL_POS;
    finalText += " ï¼ˆå·²ç›´é”çµ‚é»ï¼ï¼‰";
    moved = true;
    isWin = true;
  } else if (eventText === "çµ‚é»") {
    isWin = true;
  }
  
  const logMsg = `<span class="player-name">[${players[playerId].name}]</span> æ ¼å­ ${pos}ï¼š${finalText}${isWin ? ' ğŸ‰ åˆ°é”çµ‚é»ï¼è´äº†ï¼' : ''}`;
  addToLog(logMsg);
  
  const alertMsg = `${players[playerId].name} è¸©åˆ°äº‹ä»¶æ ¼ï¼\n${finalText}${isWin ? '\nğŸ‰ æ­å–œåˆ°é”çµ‚é»ï¼' : ''}`;
  alert(alertMsg);
  
  if (moved) {
    setPlayerPosition(playerId, newPos);
    setTimeout(() => checkEventAfterMove(playerId, depth + 1), 800);
  }
}

function resetGame() {
  if (!confirm('ç¢ºå®šè¦é‡ç½®æ‰€æœ‰ç©å®¶ä½ç½®å—ï¼Ÿ')) return;
  Object.keys(players).forEach(id => {
    setPlayerPosition(id, 0);
  });
  document.getElementById('steps').value = 3;
  isMoving = false;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ äº‹ä»¶ç¶å®š â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

document.getElementById('addPlayerBtn').addEventListener('click', () => {
  if (Object.keys(players).length >= 7) {
    alert('æœ€å¤šåªèƒ½æœ‰7å€‹ç©å®¶å–”ï½');
    return;
  }
  const id = nextPlayerId++;
  players[id] = {
    name: `ç©å®¶${id}`,
    pos: 0,
    imageUrl: "player.png",
    el: null
  };
  // é è¨­ä½¿ç”¨å¾ªç’°é¡è‰²
  customPlayerColors[id] = defaultPlayerColors[id % defaultPlayerColors.length];
  createPlayer(id);
  updatePlayerListUI();
  if (!selectedPlayerId) updatePlayerSelection(id);
});

document.addEventListener('input', (e) => {
  if (e.target.classList.contains('player-name-input')) {
    const row = e.target.closest('.player-row');
    const id = row.dataset.playerId;
    players[id].name = e.target.value || `ç©å®¶${id}`;
  }
});

document.addEventListener('change', (e) => {
  if (e.target.matches('[class^="file-input-"]')) {
    const className = e.target.className;
    const id = parseInt(className.match(/\d+/)?.[0]);
    const file = e.target.files[0];
    if (file && players[id]) {
      const reader = new FileReader();
      reader.onload = function(ev) {
        players[id].imageUrl = ev.target.result;
        if (players[id].el) {
          players[id].el.style.backgroundImage = `url(${ev.target.result})`;
        }
      };
      reader.readAsDataURL(file);
    }
  }
});

document.getElementById('moveBtn').addEventListener('click', startMovePlayer);

document.querySelectorAll('.gift-item').forEach(item => {
  item.addEventListener('click', () => {
    const steps = parseInt(item.dataset.steps) || 0;
    useGift(steps);
  });
});

document.getElementById('resetBtn').addEventListener('click', resetGame);

document.getElementById('clearLogBtn').addEventListener('click', () => {
  if (confirm("ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰äº‹ä»¶ç´€éŒ„å—ï¼Ÿ")) {
    eventLog = [];
    document.getElementById('log-content').innerHTML = "å°šæœªè§¸ç™¼ä»»ä½•äº‹ä»¶";
  }
});

document.getElementById('copyLogBtn').addEventListener('click', () => {
  if (eventLog.length === 0) {
    alert("ç›®å‰æ²’æœ‰ä»»ä½•äº‹ä»¶å¯è¤‡è£½");
    return;
  }
  const logText = eventLog.map((item, i) => `${i+1}. ${item}`).join('\n');
  navigator.clipboard.writeText(logText)
    .then(() => alert("å·²è¤‡è£½å…¨éƒ¨äº‹ä»¶ç´€éŒ„åˆ°å‰ªè²¼ç°¿ï¼"))
    .catch(() => alert("è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•é¸å–è¤‡è£½"));
});

window.addEventListener('load', () => {
  document.getElementById('addPlayerBtn').click();
  updateScale();
});

window.addEventListener('resize', updateScale);
</script>
</body>
</html>